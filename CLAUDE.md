# Porcana MVP API Contract (Frontend 공유??

## Development Philosophy

### Request DTO as Record
- **Request DTO**: Java Record????성 (불???? 간결??
- **Response DTO**: @Builder + Lombok ??용 (??연????성)
- **Command DTO**: @Builder + Lombok ??용 (???? 로직??

**Request DTO Example:**
```java
public record SignupRequest(
    @Email(message = "??바????메????식????닙??다")
    String email,

    @NotBlank(message = "비??번호????수??니??)
    @Size(min = 8, message = "비??번호??최소 8????상??어????니??)
    String password,

    @NotBlank(message = "??네???? ??수??니??)
    String nickname
) {
}
```

**??유:**
- Record??불?? 객체??API ??청 ??이??에 ??합
- Validation annotation????드??직접 ??용 가??
- getter 메서????동 ??성 (field명과 ??일: `request.email()`)
- equals/hashCode/toString ??동 ??성

### Command Pattern
- **Controller**: Request DTO ??신 ??Command ??성 (Command.from(request)) ??Service ??출
- **Command**: Request로??????신????성??는 ??적 ??토??메서????공
- **Service**: Command DTO ??신 ??비즈??스 로직 처리
- **Entity**: Command로??????성 (Entity.from(command))

**Flow Example:**
```
Request DTO (SignupRequest)
    ??Command????적 ??토??메서??
Command DTO (SignupCommand.from(request))
    ??Service????달
Entity (User.from(command))
```

**Code Example:**
```java
// Controller
@PostMapping("/signup")
public ResponseEntity<AuthResponse> signup(@RequestBody SignupRequest request) {
    SignupCommand command = SignupCommand.from(request);
    AuthResponse response = authService.signup(command);
    return ResponseEntity.ok(response);
}

// Command
public static SignupCommand from(SignupRequest request) {
    return SignupCommand.builder()
        .email(request.email())
        .password(request.password())
        .nickname(request.mickname())
        .provider(User.AuthProvider.EMAIL)
        .build();
}
```

**??유:**
- 계층 ??명확??책임 분리
- Request DTO??API ??펙??종속, Command????메??로직??집중
- **변??로직??Command가 ??유** ??Controller????순????출??
- Entity ??성 로직??Entity ??????캡슐??

### Swagger Authentication (JWT)
- **Bearer Token 방식**: Swagger UI??서 JWT ??큰 ??증 지??
- **Annotation 기반 구분**: @SecurityRequirement????증 ??요 API ??시
- **SecurityScheme ??정**: SwaggerConfig??서 JWT scheme ??록

**??증????요??API:**
```java
@SecurityRequirement(name = "JWT")
@RestController
@RequestMapping("/api/v1")
public class UserController {
    // ??컨트롤러??모든 ??드??인??에 JWT ??요
    // Swagger UI??서 ??물????이????시??
}
```

**??증????요??는 API:**
```java
@RestController
@RequestMapping("/api/v1/auth")
public class AuthController {
    // @SecurityRequirement ??음 = 공개 API
    // Swagger UI??서 ??물????이????음
}
```

**Custom Annotation - @CurrentUser:**
```java
@GetMapping("/me")
public ResponseEntity<UserResponse> getMe(@CurrentUser UUID userId) {
    // @CurrentUser: JWT ??큰??서 userId ??동 추출
    // CurrentUserArgumentResolver가 SecurityContext??서 userId ??싱
}
```

**??유:**
- API????증 ??구??항??명확??구분
- Swagger UI??서 ??각??으????증 ??요 ???? ??인 가??
- @CurrentUser??반복??인 ??증 처리 코드 ??거

---

## Data Model & Batch Strategy

### Asset (종목) Entity

종목 ??이???? Record ??태??관리하??불?? ??이블입??다.

**??드 ??계:**
- `id`: UUID (Primary Key)
- `market`: ENUM (KR | US) - ??장 구분
- `symbol`: String - 종목 코드 (US: AAPL, KR: 005930)
- `name`: String - 종목??
- `type`: ENUM (STOCK | ETF) - ??품 ??형
- `sector`: ENUM (Sector) - GICS ???? ??터 (주식 ??용, ETF??NULL)
- `asset_class`: ENUM (AssetClass) - ETF ??산 ??래??(ETF ??용, STOCK?? NULL)
- `universe_tags`: List<UniverseTag> - ??니버스 ??그 (SP500, NASDAQ100, KOSPI200, KOSDAQ150 ??
- `current_risk_level`: Integer (1~5) - ??재 ??험??(1: Low, 5: High)
- `active`: Boolean - ??성?????? (카드 ??????함 ????)
- `as_of`: LocalDate - 기????(????코???? "??제 기??"????)
- `created_at`: LocalDateTime
- `updated_at`: LocalDateTime

**Entity Example:**
```java
@Entity
@Table(name = "assets")
public class Asset {
    @Id
    private UUID id;

    @Enumerated(EnumType.STRING)
    private Market market;  // KR, US

    private String symbol;  // AAPL, 005930
    private String name;

    @Enumerated(EnumType.STRING)
    private AssetType type;  // STOCK, ETF

    @Enumerated(EnumType.STRING)
    private Sector sector;  // GICS ???? ??터 (주식 ??용)

    @Enumerated(EnumType.STRING)
    private AssetClass assetClass;  // ETF ??산 ??래??(ETF ??용)

    @ElementCollection
    @Enumerated(EnumType.STRING)
    private List<UniverseTag> universeTags;  // [SP500, NASDAQ100]

    private Boolean active;
    private LocalDate asOf;

    public enum Market { KR, US }
    public enum AssetType { STOCK, ETF }
}
```

**Sector ENUM (GICS ????):**
```java
public enum Sector {
    MATERIALS,                  // ??재
    COMMUNICATION_SERVICES,     // 커????????션 ??비??
    CONSUMER_DISCRETIONARY,     // ??의??비??
    CONSUMER_STAPLES,          // ??수??비??
    ENERGY,                    // ??너지
    FINANCIALS,                // 금융
    HEALTH_CARE,               // ??스케??
    INDUSTRIALS,               // ??업??
    REAL_ESTATE,               // 부??산
    INFORMATION_TECHNOLOGY,    // ??보기술
    UTILITIES                  // ??틸리티
}
```

**FMP API Sector ??GICS Sector 매핑:**
- Basic Materials ??MATERIALS
- Communication Services ??COMMUNICATION_SERVICES
- Consumer Cyclical ??CONSUMER_DISCRETIONARY
- Consumer Defensive ??CONSUMER_STAPLES
- Energy ??ENERGY
- Financial Services ??FINANCIALS
- Healthcare ??HEALTH_CARE
- Industrials ??INDUSTRIALS
- Real Estate ??REAL_ESTATE
- Technology ??INFORMATION_TECHNOLOGY
- Utilities ??UTILITIES

**AssetClass ENUM (ETF 분류):**
```java
public enum AssetClass {
    EQUITY_INDEX,    // 주식 ??덱??ETF (SPY, KODEX 200)
    SECTOR,          // ??터??ETF (XLK, KODEX 반도??
    DIVIDEND,        // 배당 ETF (SCHD, TIGER 고배??
    BOND,            // 채권 ETF (TLT, KODEX ??????0??
    COMMODITY        // ??자??ETF (GLD, KRX 금현??
}
```

**주의??항:**
- `sector`??주식(STOCK) ??용 ??드?? ETF??NULL
- `assetClass`??ETF ??용 ??드?? 주식?? NULL

### Spring Batch 기반 종목 ??이????성 ??략

**??국 종목 (KR Market):**
1. **종목 ??이????집** (data.go.kr API)
   - CSV ??일(kospi200.csv, kosdaq150.csv)??서 종목 코드 목록 ??기 (??348??
   - ??종목 코드마다 data.go.kr??`getStockPriceInfo` API??개별 ??출
   - ??답 ??이???? `assets` ??이블에 upsert (초기 active=false)
   - 기본 ??보: symbol, name, exchange (KOSPI/KOSDAQ), type (STOCK/ETF)
   - 주의: ??348??종목 × API ??출????????간 ??요 (??5-10??

2. **??니버스 ??깅**
   - `kospi200.csv`: KOSPI200 구성종목 코드 목록 (??199??
   - `kosdaq150.csv`: KOSDAQ150 구성종목 코드 목록 (??149??
   - CSV??종목 코드??기????로 `universe_tags` 추??
   - ??깅??종목??`active = true` ??정 ??카드 ??????함

3. **Batch Job 구조**
   ```
   KrAssetBatchJob
   ???? Step 1: fetchKrAssetsStep
   ??  ???? CSV??서 종목 코드 ??기 ????코드마다 API ??출 ??assets ??이??upsert
   ???? Step 2: tagKospi200Step
   ??  ???? kospi200.csv 기반 ??깅 ????성??
   ???? Step 3: tagKosdaq150Step
       ???? kosdaq150.csv 기반 ??깅 ????성??
   ```

**미국 종목 (US Market):**
1. **S&P 500 구성종목 ??집** (FMP API)
   - FMP (Financial Modeling Prep) Constituents API ??용
   - Endpoint: `/api/v3/sp500_constituent`
   - ??답: symbol, name, sector, subSector ??

2. **??이??처리**
   - exchange??FMP ??답 ??는 별도 조회????인 (NASDAQ/NYSE)
   - `universe_tags = ["SP500"]`
   - `active = true` ??정
   - `type = STOCK` (ETF??별도 처리)

3. **Batch Job 구조**
   ```
   UsAssetBatchJob
   ???? Step 1: Fetch from FMP ??Upsert to assets (market=US, active=true)
   ```

**공통 처리 ??칙:**
- **Upsert ??략**: symbol + market??natural key????용, 중복 ????데??트
- **as_of 관??*: 배치 ??행??을 `as_of`??기록 (??이??의 ??점 추적)
- **active ??래??*: ??니버스????함??종목??`active=true`, ??머지??`false`
- **??력 관??*: ??요 ??`as_of` 기????로 과거 구성종목 조회 가??(??후 ??장)

**배치 ??행 주기:**
- 초기 ??이??구축: ??동 ??행 (./gradlew bootRun --args='--spring.batch.job.names=krAssetBatchJob')
- ??기 ??데??트: ??1??????줄링 (매주 ??요??02:00 KST)

### ETF ??이????성 ??략

**??국 ETF (KR Market):**
1. **ETF ??이????집** (CSV 기반)
   - CSV ??일 (`kr_etf.csv`)??서 ETF 목록 ??기
   - ??맷: `symbol, name, asset_class`
   - ??시: `069500, KODEX 200, EQUITY_INDEX`

2. **??이??처리**
   - `type = ETF`
   - `active = true` (CSV????는 ETF??모두 ??성??
   - `assetClass` 매핑: CSV??asset_class 컬럼 ??

3. **Batch Job 구조**
   ```
   KrEtfBatchJob
   ???? Step 1: importKrEtfsStep
   ??  ???? kr_etf.csv ??기 ??assets ??이??upsert
   ???? Step 2: fetchKrEtfHistoricalPricesStep
       ???? 과거 1??치 가????이????집 (24??간 ??내 ??성??ETF??
   ```

4. **가????이????스**
   - API: data.go.kr `GetSecuritiesProductInfoService/getETFPriceInfo`
   - 과거 1??치 ??일 가????이????집

**미국 ETF (US Market):**
1. **ETF ??이????집** (CSV 기반)
   - CSV ??일 (`us_etf.csv`)??서 ETF 목록 ??기
   - ??맷: `symbol, name, asset_class`
   - ??시: `SPY, S&P 500 ETF, EQUITY_INDEX`

2. **??이??처리**
   - `type = ETF`
   - `active = true`
   - `assetClass` 매핑: CSV??asset_class 컬럼 ??

3. **Batch Job 구조**
   ```
   UsEtfBatchJob
   ???? Step 1: importUsEtfsStep
   ??  ???? us_etf.csv ??기 ??assets ??이??upsert
   ???? Step 2: fetchUsEtfHistoricalPricesStep
       ???? 과거 1??치 가????이????집 (24??간 ??내 ??성??ETF??
   ```

4. **가????이????스**
   - API: FMP `historical-price-eod`
   - 주식????일??API ??용

**배치 ??행 주기:**
- 초기 ??이??구축: ??동 ??행
  ```bash
  ./gradlew bootRun --args='--spring.batch.job.names=krEtfJob'
  ./gradlew bootRun --args='--spring.batch.job.names=usEtfJob'
  ```
- ??기 ??데??트: ??1??????줄링 (매주 ??요??02:00 KST, 주식????께)

---

## Spring Batch 기반 ??일 가????데??트 ??략

### AssetPrice (가????이?? Entity

종목????별 종?? ??거래????이???? ????합??다.

**??드 ??계:**
- `id`: UUID (Primary Key)
- `asset_id`: UUID (Foreign Key ??assets)
- `price_date`: LocalDate - 거래??
- `price`: BigDecimal - 종??
- `volume`: Long - 거래??
- `created_at`: LocalDateTime

**Unique Index:** `(asset_id, price_date)` - 중복 방??

### ??일 가????데??트 배치 Job

**??국 주식 (krDailyPriceJob):**
- **????*: `active = true AND type = STOCK`??모든 ??국 주식
- **??이????스**: data.go.kr API (`getStockPriceInfo`)
- **처리 로직**:
  1. active??주식 목록 조회
  2. ??종목마다 최근 5??치 ??이????청 (최신 거래????보)
  3. 최신 거래??가??추출
  4. 중복 체크 (`asset_id + price_date`)
  5. ??규 가격만 ????
- **Rate Limiting**: 100ms ??레??
- **??행 주기**: ????일 18:00 KST (??마감 15:30 ??후)

**??국 ETF (krEtfDailyPriceJob):**
- **????*: `active = true AND type = ETF`??모든 ??국 ETF
- **??이????스**: data.go.kr API (`getETFPriceInfo`)
- **처리 로직**: 주식????일
- **Rate Limiting**: 100ms ??레??
- **??행 주기**: ????일 18:00 KST (주식 가????데??트 직후)

**미국 주식 (usDailyPriceJob):**
- **????*: `active = true AND type = STOCK`??모든 미국 주식
- **??이????스**: FMP API (`historical-price-eod`)
- **처리 로직**:
  1. active??주식 목록 조회
  2. ??종목마다 최근 3??치 ??이????청 (최신 거래????보)
  3. 최신 거래??가??추출 (FMP??최신????렬)
  4. 중복 체크 (`asset_id + price_date`)
  5. ??규 가격만 ????
- **Rate Limiting**: 150ms ??레??
- **??행 주기**: ????일 07:00 KST (미국 ??마감 ?? TUE-SAT KST = MON-FRI EST)

**미국 ETF (usEtfDailyPriceJob):**
- **????*: `active = true AND type = ETF`??모든 미국 ETF
- **??이????스**: FMP API (`historical-price-eod`)
- **처리 로직**: 주식????일 (FMP API??주식/ETF 구분 ??이 ??일 ??드??인??
- **Rate Limiting**: 150ms ??레??
- **??행 주기**: ????일 07:00 KST (주식 가????데??트 직후)

**배치 ????줄링 (BatchConfig):**
```java
// ??국 ??장: ??일 18:00 KST
@Scheduled(cron = "0 0 18 * * MON-FRI", zone = "Asia/Seoul")
public void runKrDailyPriceUpdate()

// 미국 ??장: ??일 07:00 KST (???? ??차 고려)
@Scheduled(cron = "0 0 7 * * TUE-SAT", zone = "Asia/Seoul")
public void runUsDailyPriceUpdate()
```

**??동 ??행:**
```bash
# ??국 주식 ??일 가????데??트
./gradlew bootRun --args='--spring.batch.job.names=krDailyPriceJob'

# ??국 ETF ??일 가????데??트
./gradlew bootRun --args='--spring.batch.job.names=krEtfDailyPriceJob'

# 미국 주식 ??일 가????데??트
./gradlew bootRun --args='--spring.batch.job.names=usDailyPriceJob'

# 미국 ETF ??일 가????데??트
./gradlew bootRun --args='--spring.batch.job.names=usEtfDailyPriceJob'
```

---

## US 종목 ????지 ??데??트

### US ????지 ??데??트 배치 Job

**????지 ??데??트 (usImageUpdateJob):**
- **????*: 모든 US STOCK ??산 (active/inactive 무??)
- **??이????스**: FMP API (`/stable/profile`)
- **처리 로직**:
  1. 모든 US 주식 ??산 조회
  2. ??종목마다 FMP profile API ??출
  3. `image` ??드 추출
  4. `imageUrl` ??드 ??데??트
  5. Rate limiting: 150ms ??레??
- **??행 주기**: ??요 ????동 ??행
  - 초기 ????지 ??이??구축 ??는 ????지 ??락 종목 보완??

**??동 ??행:**
```bash
./gradlew bootRun --args='--spring.batch.job.names=usImageUpdateJob'
```

**참고:**
- US 주식/ETF ??성 배치 (`usAssetJob`, `usEtfJob`)??서 ????지 URL????동??로 ??함??
- ??배치??기존 ??산??????지????괄 ??데??트????만 ??용
- FMP API??????지 URL ??맷: `https://financialmodelingprep.com/image-stock/{SYMBOL}.png`
- ??국 종목?? ????지 ??스가 ??어 지??하지 ??음

---

## ??율 ??이??관??

### ExchangeRate (??율) Entity

??일 ??율 ??보??????합??다.

**??드 ??계:**
- `id`: UUID (Primary Key)
- `currency_code`: ENUM (CurrencyCode) - ??화 코드
- `currency_name`: String - ??화??
- `base_rate`: BigDecimal - 매매기????(KRW 기??)
- `buy_rate`: BigDecimal - ??금 받을 ????율 (????
- `sell_rate`: BigDecimal - ??금 보낼 ????율 (????
- `exchange_date`: LocalDate - ??율 기????
- `created_at`: LocalDateTime

**Unique Index:** `(currency_code, exchange_date)` - 중복 방??

**CurrencyCode ENUM:**
```java
public enum CurrencyCode {
    // 주요 ??화
    USD, JPY, EUR, CNY,
    // ??럽
    GBP, CHF, SEK, CZK, DKK, NOK, HUF, PLN, RUB, TRY,
    // ??시????세??니??
    HKD, TWD, SGD, THB, MYR, IDR, PHP, VND, INR, AUD, NZD,
    PKR, BDT, MNT, KZT, BND, FJD,
    // 중동
    SAR, KWD, BHD, AED, QAR, OMR, JOD, ILS, EGP,
    // ??메리카
    CAD, MXN, BRL, CLP,
    // ??프리카
    ZAR
    // ??44????화
}
```

### ??일 ??율 ??데??트 배치 Job

**??율 ??데??트 (exchangeRateJob):**
- **????*: ??국??출??????이 ??공??는 모든 ??화
- **??이????스**: ??국??출??????API
  - API: `https://oapi.koreaexim.go.kr/site/program/financial/exchangeJSON`
  - ??라미터: `authkey`, `searchdate` (YYYYMMDD), `data=AP01`
- **처리 로직**:
  1. ??늘 ??짜 기????로 ??율 ??이????청
  2. API ??답??서 ??화 코드 ??싱 (?? "JPY(100)" ??"JPY")
  3. CurrencyCode enum????의????화????터??(지??하지 ??는 ??화????동 ??킵)
  4. 중복 체크 (`currency_code + exchange_date`)
  5. Upsert 처리
- **??행 주기**: ????일 12:00 KST
  - ??국??출???????? ??일 10??경 ??율 ??데??트
  - ??업??일 11????전 ??이????청 ??null 반환??????어 12??에 ??행

**??동 ??행:**
```bash
./gradlew bootRun --args='--spring.batch.job.names=exchangeRateJob'
```

---

## 종목 ??험??관??

### AssetRiskHistory (??험????력) Entity

종목????험??계산 ??력??????위??????합??다.

**??드 ??계:**
- `id`: UUID (Primary Key)
- `asset_id`: UUID (Foreign Key ??assets)
- `week`: String (YYYY-WW ??맷, ?? "2025-W03")
- `risk_level`: Integer (1~5) - ??험????벨
- `risk_score`: BigDecimal - ??험????수 (0~100)
- `volatility`: BigDecimal - 변??성 (??율??
- `max_drawdown`: BigDecimal - 최????폭 (MDD)
- `worst_day_return`: BigDecimal - 1??최악 ??락??
- `factors_snapshot`: JSON - 계산????용??추?? ??소 ??냅??
- `created_at`: LocalDateTime

**Unique Index:** `(asset_id, week)` - 중복 방??

### ??험????????략

**??계 ??칙:**
- **??재 ??험??*: `Asset.currentRiskLevel` ??드??????(1~5)
- **과거 ??력**: `AssetRiskHistory` ??이블에 ????위??????
- **??험??는 계산 결과??*: ??익률처?????? ??계????이???? ??님
- **??비??에????요????*: "지????험??
- **??스??리????명·분석·메?? 리포??용**

### ??험??계산 방식

**??제 조건:**
- ??험??는 **??익??returns) 기반**??로 계산
- ??율/가????위?? 무????게 미장/??국????합 가??
- ??간 로그??익?? `r_t = ln(P_t / P_{t-1})`

**??심 지??3??**

1. **변??성 (Volatility)** - 최근 60 거래??
   - ??????차????율?? `vol = std(r_{t-59..t}) × ??52`
   - ????: "??소????들림이 ??마??????"

2. **최????폭 (MDD)** - 최근 252 거래??
   - ??적 가격의 고점 ??????????락 최????
   - `mdd = max_t(1 - P_t / max(P_{0..t}))`
   - ????: "??번 무너지????마????게 무너졌나"

3. **1??최악 ??락 (Worst Day)** - 최근 252 거래??
   - `worst = min(r_{t-251..t})`
   - ????: "??????급락 같?? 꼬리리스??

**??수??(????????일): ??센??????규??*

미장/??국??ETF/주식??같?? ??????로 만들????해 ??센??????용:

```
????산 i??????
- volPct = percentile_rank(vol_i)
- mddPct = percentile_rank(mdd_i)
- worstPct = percentile_rank(-worst_i)  // worst가 ????급락??수????험??

??센????범위: 0~1
```

**최종 RiskScore (0~100):**

```
riskScore = 100 × (0.45 × volPct + 0.45 × mddPct + 0.10 × worstPct)

가중치:
- 변??성: 45%
- 최????폭: 45%
- 꼬리리스?? 10%
```

**RiskLevel 1~5 매핑 (??????기??):**

- 0~20 ??1 (Low)
- 20~40 ??2
- 40~60 ??3
- 60~80 ??4
- 80~100 ??5 (High)

**??계 ??징:**
- **모든 ??산????일????험??규칙 ??용** (마켓/ETF/주식 구분 ??음)
- **??험??는 ???? ??????*: "??험??4"????떤 ??산??든 ??일??????
- **ETF????연??럽??????험**??로 계산??(별도 규칙 불필??
- **??센????기반**??라 ??장 ??체가 불안??져??"????????험"??????

### 주간 ??험??계산 배치 Job

**??험??계산 (assetRiskJob):**
- **????*: `active = true`??모든 종목 (주식 + ETF, ??국 + 미국)
- **??이????스**: `asset_prices` ??이??(??봉 종??)
- **처리 로직**:
  1. ????산??최근 252??가????이??로딩
  2. ????산별로 returns 계산
  3. Volatility, MDD, Worst Day 계산
  4. ??체 ??산 기?? ??센??????출
  5. riskScore 계산 (0~100)
  6. riskLevel 매핑 (1~5)
  7. `Asset.currentRiskLevel` ??데??트
  8. `AssetRiskHistory` insert (week, riskLevel, riskScore, volatility, mdd, worstDayReturn)
- **??행 주기**: 매주 ??요??03:00 KST
  - 주간 종목 ??데??트 (02:00) 직후 ??행
  - 최근 8~12????이??rolling window????험????계??

**??동 ??행:**
```bash
./gradlew bootRun --args='--spring.batch.job.names=assetRiskJob'
```

**??이????구??항:**
- **??요????이??*: ??봉 종????(최소 252?? 부족하??가??한 범위 ??계산)
- **????주기**: ??1??
- **??스??리 관??*: week(YYYY-WW) 기????로 과거 ??험??조회 가??

---

## 게스????션 (비회????트??리??지??

### ??계 목표

**비회??도 ??트??리???? ??성??????도????여 ??환??을 ??인??**

- 비회???? `guest_sessions`??"??시 ??유????가진다
- ??원가??로그????`guest_session_id ??user_id`??**??유????전(claim)** ??다

### GuestSession Entity

게스????용??의 ??시 ??션 ??보??????합??다.

**??드 ??계:**
- `id`: UUID (Primary Key)
- `created_at`: LocalDateTime - ??션 ??성 ??각
- `last_seen_at`: LocalDateTime - 마??????동 ??각 (만료 ??단??

**??션 관??**
- 클라이언트는 `X-Guest-Session-Id`를 저장해 다음 요청에 포함
- 만료 ??책: `last_seen_at` 기?? 30????상 비활????배치??????
- ??한: 게스??당 ??트??리??최?? 3??

### Portfolio, ArenaSession ??유????장

**기존:**
- `user_id UUID NOT NULL` (??원????유 가??

**변??**
- `user_id UUID NULL` (nullable??변??
- `guest_session_id UUID NULL` 추??
- **XOR ??약**: ??????확????나??NOT NULL??어????

```sql
ALTER TABLE portfolios
  ADD CONSTRAINT ck_portfolios_owner_xor
  CHECK (
    (user_id IS NULL AND guest_session_id IS NOT NULL)
    OR
    (user_id IS NOT NULL AND guest_session_id IS NULL)
  );
```

**??일????약??`arena_sessions`??도 ??용**

### Claim (??유????전) 로직

??원가??로그????게스????트??리???? ??용??계정??로 ??전??니??

**??랜???? 처리:**
```java
@Transactional
public void claimGuestPortfolios(UUID guestSessionId, UUID userId) {
  // 1) 게스????트??리??조회 (FOR UPDATE????시????어)
  List<Portfolio> guestPortfolios =
      portfolioRepository.findByGuestSessionIdForUpdate(guestSessionId);

  if (guestPortfolios.isEmpty()) return; // 멱등??

  // 2) ??유????전
  for (Portfolio p : guestPortfolios) {
    p.claimToUser(userId); // userId ??팅 + guestSessionId null
  }

  // 3) 메인 ??트??리????동 ??정 (??을 ??만)
  User user = userRepository.findByIdForUpdate(userId);
  if (user.getMainPortfolioId() == null) {
    UUID newest = guestPortfolios.stream()
        .max(Comparator.comparing(Portfolio::getCreatedAt))
        .get().getId();
    user.setMainPortfolioId(newest);
  }
}
```

**??심 ??인??**
- `FOR UPDATE` ??용??로 ??시 claim 방??
- 멱등??보장 (???? claim????션?? ??킵)
- 메인 ??트??리????동 ??정 (최신 게스????트??리??

### 게스????션 ??책

**MVP 규칙:**
1. **게스????트??리????한**: 최?? 3??
2. **??원가????병합**: 기존 계정 ??트??리??+ 게스????트??리??모두 ???? (merge)
3. **만료 ??책**: 30??간 미사????배치?????? (`last_seen_at` 기??)

---

## 배치 ????????체 ??약

### 주간 ??????(??요??

**02:00 KST** - 종목 ??이????데??트
```
runWeeklyAssetUpdate()
???? krAssetJob - ??국 주식 종목 ??데??트
???? krEtfJob - ??국 ETF 종목 ??데??트 + 과거 가??
???? usAssetJob - 미국 주식 종목 ??데??트
???? usEtfJob - 미국 ETF 종목 ??데??트 + 과거 가??
```

**03:00 KST** - ??험??계산
```
runWeeklyRiskUpdate()
???? assetRiskJob - 종목 ??험??계산 ????데??트
```

### ??일 ??????(??일)

**07:00 KST (????** - 미국 ??장 가????데??트
```
runUsDailyPriceUpdate()
???? usDailyPriceJob - 미국 주식 가??
???? usEtfDailyPriceJob - 미국 ETF 가??
```

**12:00 KST (????** - ??율 ??데??트
```
runExchangeRateUpdate()
???? exchangeRateJob - ??율 ??이??
```

**18:00 KST (????** - ??국 ??장 가????데??트
```
runKrDailyPriceUpdate()
???? krDailyPriceJob - ??국 주식 가??
???? krEtfDailyPriceJob - ??국 ETF 가??
```

---

## Base
- Base Path: /api/v1
- Auth: Authorization: Bearer {accessToken}
- Content-Type: application/json
- Date format: ISO-8601 (YYYY-MM-DD for chart points)
- Enum:
    - PortfolioStatus: DRAFT | ACTIVE | FINISHED

## Screen List (MVP)
1) Login
2) Home (main portfolio widget only)
3) Portfolio List
4) Portfolio Create Start
5) Arena Round (pick 1 of 3 assets)
6) Portfolio Create Complete
7) Portfolio Detail
8) Portfolio Performance Chart (tab or separate)
9) Asset Detail

---

# 0) Guest Session (비회??지??

## POST /guest-sessions
**Description**: 비회??을 ??한 게스????션????성??니?? ??버????동??로 헤더????정??니??

**Auth**: Not required

Request
```json
{}
```

Response (201 Created)
```json
{
  "guestSessionId": "uuid"
}
```

**Response Header:**
```text
X-Guest-Session-Id: {sessionId}
```

**Notes:**
- ??론??엔??는 `X-Guest-Session-Id` 헤더가 ??을 ??만 ??출
- 클라이언트는 `X-Guest-Session-Id`를 저장해 다음 요청에 포함
- ??버깅용??로 `guestSessionId`????답????함?????? ??제로는 헤더로만 관??

---

# 1) Auth / User

## POST /auth/signup
**Description**: ??원가??을 처리??니?? ??청??`X-Guest-Session-Id` 헤더가 ??으??게스????트??리???? ??동??로 ??용??계정??로 ??전??니??

**Auth**: Not required

**Guest Session Claim:**
- ??버????청??`X-Guest-Session-Id` 헤더????인
- 게스????션????으????당 ??트??리????레???? ??규 ??용??계정??로 ??전
- 메인 ??트??리???? ??으??가??최근 게스????트??리???? 메인??로 ??정

Request
```json
{
  "email": "string",
  "password": "string",
  "nickname": "string"
}
```

Response (200 OK)
```json
{
  "accessToken": "string",
  "refreshToken": "string",
  "user": {
    "userId": "uuid",
    "nickname": "string",
    "mainPortfolioId": "uuid|null"
  }
}
```

## GET /auth/check-email?email=string
Check if email is available for signup

Response
{
"available": true|false
}

## POST /auth/login
**Description**: 로그??을 처리??니?? ??청??`X-Guest-Session-Id` 헤더가 ??으??게스????트??리???? ??동??로 ??용??계정??로 ??전??니??

**Auth**: Not required

**지??Provider**: EMAIL, GOOGLE, APPLE

**Guest Session Claim:**
- ??버????청??`X-Guest-Session-Id` 헤더????인
- 게스????션????으????당 ??트??리????레???? ??용??계정??로 ??전 (merge)
- 기존 ??트??리???? 게스????트??리??모두 ????

Request (EMAIL provider)
```json
{
  "provider": "EMAIL",
  "email": "string",
  "password": "string"
}
```

Request (OAuth providers - GOOGLE, APPLE)
```json
{
  "provider": "GOOGLE|APPLE",
  "code": "string"
}
```

Response (200 OK)
```json
{
  "accessToken": "string",
  "refreshToken": "string",
  "user": {
    "userId": "uuid",
    "nickname": "string",
    "mainPortfolioId": "uuid|null"
  }
}
```

**Validation Notes:**
- EMAIL provider: email, password ??수
- GOOGLE/APPLE provider: code ??수 (OAuth authorization code)
- 커스?? validator (@ValidLoginRequest)??provider????수 ??드 검??

## POST /auth/refresh
Request
{
"refreshToken": "string"
}
Response
{
"accessToken": "string",
"refreshToken": "string"
}

## GET /me
**Description**: ??재 ??증????용??의 최신 ??보??조회??니?? 로그????원가????user ??보가 ??답????함?????? ??API????큰??로 최신 ???? ??보??조회??????용??니??

**Auth**: Required (JWT)
Response
{
"userId": "uuid",
"nickname": "string",
"mainPortfolioId": "uuid|null"
}

## PATCH /me
**Auth**: Required (JWT)

Request
{
"nickname": "string"
}
Response
{
"userId": "uuid",
"nickname": "string"
}

---

# 2) Home (Main Portfolio Widget)

## GET /home
Response (when no main portfolio)
{
"hasMainPortfolio": false
}

Response (when has main portfolio)
{
"hasMainPortfolio": true,
"mainPortfolio": {
"portfolioId": "uuid",
"name": "string",
"startedAt": "YYYY-MM-DD",
"totalReturnPct": 12.34
},
"chart": [
{ "date": "YYYY-MM-DD", "value": 100.0 }
],
"positions": [
{
"assetId": "uuid",
"ticker": "string",
"name": "string",
"weightPct": 25.0,
"returnPct": 18.3
}
]
}

## PUT /portfolios/{portfolioId}/main
**Description**: 지??한 ??트??리???? 메인 ??트??리??로 ??정??니?? ??른 ??트??리???? ???? 메인??로 ??정??어 ??다??변경됩??다.

Response
{ "mainPortfolioId": "uuid" }

---

# 3) Portfolio List

## GET /portfolios
**Note**: DRAFT ??태????트??리??는 리스??에 ??시???? ??습??다. ACTIVE ??FINISHED ??태??조회??니??

Response
[
{
"portfolioId": "uuid",
"name": "string",
"status": "ACTIVE|FINISHED",
"isMain": true,
"totalReturnPct": 12.34,
"createdAt": "YYYY-MM-DD"
}
]

---

# 4) Portfolio (CRUD minimal for MVP)

## POST /portfolios
**Description**: ??로????트??리???? ??성??니?? 비회??도 ??성 가??합??다.

**Auth**: Optional (JWT ??는 Guest Session)

**??유??결정:**
- `Authorization` ??더가 ??으??????용????유 (`user_id` ??정)
- ??으????게스????유 (`guest_session_id` ??정)
- 게스????션????으????버가 ??동 ??성

**게스????한:**
- 게스??당 최?? 3????트??리??

Request
```json
{
  "name": "string"
}
```

Response (201 Created)
```json
{
  "portfolioId": "uuid",
  "name": "string",
  "status": "DRAFT",
  "createdAt": "YYYY-MM-DD"
}
```

## GET /portfolios/{portfolioId}
Response
{
"portfolioId": "uuid",
"name": "string",
"status": "DRAFT|ACTIVE|FINISHED",
"isMain": true,
"startedAt": "YYYY-MM-DD|null",
"totalReturnPct": 12.34,
"averageRiskLevel": 3.2,
"diversityLevel": "HIGH",
"riskDistribution": {
"1": 10.0,
"2": 20.0,
"3": 30.0,
"4": 25.0,
"5": 15.0
},
"positions": [
{
"assetId": "uuid",
"ticker": "string",
"name": "string",
"currentRiskLevel": 4,
"weightPct": 25.0,
"returnPct": 18.3
}
]
}

**Portfolio-Level Risk Metrics:**
- `averageRiskLevel`: 가????균 ??험??(1.0 - 5.0, null 가??
  - ????산??currentRiskLevel × weightPct??계산
  - ?? (4 × 0.25) + (3 × 0.25) + (2 × 0.50) = 2.75
- `diversityLevel`: 분산?????? ("HIGH" | "MEDIUM" | "LOW")
  - ??터 ??양??(50%), ??험??밴드 ??양??(30%), ??산 ??????양??(20%) 종합
  - HIGH: 70????상 (??러 ??터, ??러 ??험?? 주식+ETF ??합)
  - MEDIUM: 40-70??
  - LOW: 40??미만 (??일 ??터, ??일 ??험?? ??일 ????
- `riskDistribution`: ??험??별 비중 분포 (Map<Integer, Double>)
  - Key: ??험????벨 (1-5)
  - Value: ??당 ??험????산??의 비중 ??계 (%)
  - ?? { "1": 10.0, "2": 20.0, "3": 30.0, "4": 25.0, "5": 15.0 }
  - 모든 ??벨 (1-5)?????? ??함??며, ??는 ??벨?? 0.0%
  - ??계??100%가 ??어????(riskLevel??null????산 ??외)


---

# 5) Arena (Hearthstone-style drafting)

## POST /arena/sessions
**Description**: ??트??리??에 ??????로????레????래??트 ??션????작??니?? ???? 진행 중인 ??션????으????당 ??션??반환??니?? 비회??도 ??용 가??합??다.

**Auth**: Optional (JWT ??는 Guest Session)

**??유??결정:**
- `Authorization` ??더가 ??으??????용????유 (`user_id` ??정)
- ??으????게스????유 (`guest_session_id` ??정)
- ??트??리????유권과 ??치??는 ??션????성 가??

Request
```json
{
  "portfolioId": "uuid"
}
```

Response (200 OK)
```json
{
  "sessionId": "uuid",
  "portfolioId": "uuid",
  "status": "IN_PROGRESS",
  "currentRound": 0
}
```

Error Responses
- 400: ??트??리???? 찾을 ????거??권한????음
- 403: ??트??리????유권이 ??치???? ??음

---

## GET /arena/sessions/{sessionId}
**Description**: 진행 중이거나 ??료????레????션????세 ??보??조회??니??

**Auth**: Required (JWT)

Response (200 OK)
{
"sessionId": "uuid",
"portfolioId": "uuid",
"status": "IN_PROGRESS|COMPLETED",
"currentRound": 3,
"totalRounds": 11,
"riskProfile": "BALANCED",
"selectedSectors": ["INFORMATION_TECHNOLOGY", "HEALTH_CARE"],
"selectedAssetIds": ["uuid1", "uuid2"]
}

Error Responses
- 403: ??션??찾을 ????거??권한????음
- 401: ??증 ??요

---

## GET /arena/sessions/{sessionId}/rounds/current
**Description**: ??재 진행 중인 ??운??의 ??택지??조회??니??
- Round 0: ??자 ??향 + ??터 ??시 ??택 (Pre Round)
- Round 1-10: ??산 ??택

**Auth**: Required (JWT)

Response for Round 0 (Pre Round - Risk Profile + Sector Selection)
{
"sessionId": "uuid",
"round": 0,
"roundType": "PRE_ROUND",
"riskProfileOptions": [
{
"value": "AGGRESSIVE",
"displayName": "공격??,
"description": "고위??고수??을 추구??는 ??자 ??향"
},
{
"value": "BALANCED",
"displayName": "균형",
"description": "??험????익??균형??추구??는 ??자 ??향"
},
{
"value": "SAFE",
"displayName": "보수??,
"description": "??정??인 ??익??추구??는 ????험 ??자 ??향"
}
],
"sectorOptions": [
{
"value": "INFORMATION_TECHNOLOGY",
"displayName": "??보기술",
"assetCount": 45
},
{
"value": "HEALTH_CARE",
"displayName": "??스케??,
"assetCount": 38
},
// ... more sectors
],
"minSectorSelection": 0,
"maxSectorSelection": 3
}

**Field Notes:**
- `riskProfileOptions`: ??자 ??향 ??택지 (SAFE/BALANCED/AGGRESSIVE ??1????수 ??택)
- `sectorOptions`: ??터 ??택지 (0-3????택 가??
- `value`: Sector enum ??
- `displayName`: ??국????터??
- `assetCount`: ??당 ??터????한 ??성 ??산 개수

Response for Round 1-10 (Asset Selection)
{
"sessionId": "uuid",
"round": 3,
"roundType": "ASSET",
"assets": [
{
"assetId": "uuid",
"ticker": "AAPL",
"name": "Apple Inc.",
"sector": "INFORMATION_TECHNOLOGY",
"market": "US",
"assetClass": null,
"currentRiskLevel": 4,
"imageUrl": "https://financialmodelingprep.com/image-stock/AAPL.png",
"impactHint": "??장 비중 ??· 변??성 ??
},
{
"assetId": "uuid",
"ticker": "MSFT",
"name": "Microsoft Corp.",
"sector": "INFORMATION_TECHNOLOGY",
"market": "US",
"assetClass": null,
"currentRiskLevel": 3,
"imageUrl": "https://financialmodelingprep.com/image-stock/MSFT.png",
"impactHint": "??장 비중 ??· 균형"
},
{
"assetId": "uuid",
"ticker": "SPY",
"name": "SPDR S&P 500 ETF",
"sector": null,
"market": "US",
"assetClass": "EQUITY_INDEX",
"currentRiskLevel": 2,
"imageUrl": "https://financialmodelingprep.com/image-stock/SPY.png",
"impactHint": "분산 ??과 · 균형"
}
]
}

**Field Notes:**
- `sector`: 주식(STOCK)??경우 GICS ??터, ETF??null
- `market`: ??장 구분 (KR | US)
- `assetClass`: ETF??경우 ??산 ??래??(EQUITY_INDEX, DIVIDEND, BOND ??, 주식?? null
- `currentRiskLevel`: ??험????벨 (1-5, 1: Low, 5: High, null 가??
- `imageUrl`: ??사 로고 ????지 URL (미국 주식/ETF????공, ??국 종목?? null)
  - FMP API ??공: `https://financialmodelingprep.com/image-stock/{SYMBOL}.png`
- `impactHint`: ??트??리??에 미치????향 ??트 (???? · 리스??
  - ????: ETF??assetClass 기반 ("분산 ??과", "배당 기여", "방어 ????"), 주식?? sector 기반 ("??장 비중 ??, "경기 민감", "방어??)
  - 리스?? currentRiskLevel 기반 ("변??성 ??, "균형", "??정????)

Error Responses
- 400: ??션?????? ??료??
- 403: ??션??찾을 ????거??권한????음
- 401: ??증 ??요

---

## POST /arena/sessions/{sessionId}/rounds/current/pick-preferences
**Description**: ??레??Round 0 (Pre Round)??서 ??자 ??향(리스????로????관????터????시????택??니?? 0-3개의 ??터????택??????으?? 중복?? ??용???? ??습??다.

**Auth**: Required (JWT)

Request
{
"riskProfile": "SAFE|BALANCED|AGGRESSIVE",
"sectors": ["INFORMATION_TECHNOLOGY", "HEALTH_CARE"]
}

Response (200 OK)
{
"sessionId": "uuid",
"status": "IN_PROGRESS",
"currentRound": 1,
"picked": {
"riskProfile": "BALANCED",
"sectors": ["INFORMATION_TECHNOLOGY", "HEALTH_CARE"]
}
}

Error Responses
- 400: Round 0????니거나 ??터 개수가 3??초과 ??는 중복????터 ??함
- 403: ??션??찾을 ????거??권한????음
- 401: ??증 ??요

---

## POST /arena/sessions/{sessionId}/rounds/current/pick-asset
**Description**: ??레??Round 1-10??서 ??시??3개의 ??산 ??1개?? ??택??니?? Round 10 ??료 ????션??종료??고 ??트??리???? ??성??니??

**Auto Actions on Round 10 Completion:**
1. ??트??리??에 ??택??10????산 추?? (균등 비중 10% ??
2. ??트??리????냅????성
3. **??트??리????동 ??작** (DRAFT ??ACTIVE, startedAt = today)
4. **메인 ??트??리????동 ??정** (??용??의 mainPortfolioId가 null??경우)

**Auth**: Required (JWT)

Request
{
"pickedAssetId": "uuid"
}

Response (200 OK)
{
"sessionId": "uuid",
"status": "IN_PROGRESS|COMPLETED",
"currentRound": 2,
"picked": "uuid"
}

Error Responses
- 400: Round 1-10????니거나 ??시????산 목록????는 ??산 ??택
- 403: ??션??찾을 ????거??권한????음
- 401: ??증 ??요

---

# 5-1) Arena Asset Recommendation Logic

## Overview
Arena??Hearthstone-style????래??트 ??스??으?? ??용???? 3개의 ??택지 ??1개?? ??택??여 ??트??리???? 구성??니??

## Round Structure
- **Round 0 (Pre Round)**: Risk Profile + Sector ??시 ??택 (SAFE/BALANCED/AGGRESSIVE + 0-3????터)
- **Rounds 1-10**: Asset ??택 (??운??당 3????1??

## Asset Recommendation Algorithm

### Entry Point
```java
List<Asset> generateRoundOptions(ArenaSession session, int roundNo)
```

### Input Context
- `riskProfile`: SAFE | BALANCED | AGGRESSIVE
- `preferredSectors`: ??용???? ??택??2-3????터
- `deckAssetIds`: ???? ??택????산 (중복 방??)
- `shownAssetIds`: ??전 ??운??에 ??시????산 (??사??방??, ??보 부??????화)

### Optimization Strategy
**메모????율??을 ??해 ??체 ~1000??assets??로드???? ??고, ??요??subset??조회:**

1. **Preferred Candidates (Normal Picks??**
   ```java
   List<Asset> preferredCandidates = assetRepository.findBySectorInAndActiveTrue(preferredSectors);
   // ??호 ??터 (2-3??????한 ??산??로드 (??200-300??
   ```

2. **Wild Candidates (Wild Pick??**
   ```java
   List<Asset> wildCandidates = assetRepository.findBySectorNotInAndActiveTrue(preferredSectors);
   // ??호 ??터가 ??닌 ??산??(??외??보장)
   ```

3. **Filter Excluded Assets**
   ```java
   candidates = filterExcludedAssets(candidates, deckAssetIds + shownAssetIds);
   ```

### Selection Process

#### 1) Normal Picks (2??
??호 ??터 + 리스????로??+ ??양????널??반영

```java
for i in 1..2:
  next = weightedPickOne(preferredCandidates, riskProfile, preferredSectors, alreadyPicked, useSectorPreference=true);
  picked.add(next);
  preferredCandidates.remove(next);
  wildCandidates.remove(next);
```

#### 2) Wild Pick (1??
??터 ??호 무시, ??양??만 ???? (??외??보장)

```java
wild = weightedPickOne(wildCandidates, riskProfile, preferredSectors, alreadyPicked, useSectorPreference=false);
picked.add(wild);
```

### Weighted Selection Logic

#### Weight Calculation
```java
w = 1.0
w *= riskWeight(riskProfile, asset.currentRiskLevel);
w *= sectorWeight(preferredSectors, asset.sector);  // normal picks??
w *= typeWeight(asset.type);
w *= diversityPenalty(asset, alreadyPicked);
w = max(w, 0.0001);  // ??전??치
```

#### Risk Weight
```java
riskWeight(RiskProfile profile, Integer riskScore):
  if profile == SAFE:
    if riskScore in [1,2]: return 1.4
    if riskScore == 3: return 1.0
    return 0.6  // 4~5
  if profile == BALANCED:
    if riskScore in [2,3,4]: return 1.2
    return 0.8  // 1 or 5
  if profile == AGGRESSIVE:
    if riskScore in [4,5]: return 1.4
    if riskScore == 3: return 1.0
    return 0.7  // 1~2
```

#### Sector Weight
```java
sectorWeight(Set<Sector> preferredSectors, Sector sector):
  if preferredSectors.isEmpty(): return 1.0
  return preferredSectors.contains(sector) ? 1.5 : 1.0
```

#### Type Weight
```java
typeWeight(AssetType assetType):
  return assetType == ETF ? 2.5 : 1.0
  // ETF??"강하?? ??호??여 ??트??리????양????보
  // ETF??sector가 null??????sectorWeight 1.0??받음
  // 주식?? ??호 ??터 ??sectorWeight 1.5??받음
  // ??라??ETF??2.5x 부??트??주어 균형 맞춤

  // Wild Pick 추?? 보정:
  // Wild Pick(??터 ??호 무시)??서 ETF??추????1.5x 보정
  // 최종 Wild Pick ETF 가중치: 2.5 × 1.5 = 3.75x
```

#### Diversity Penalty
```java
diversityPenalty(Asset candidate, List<Asset> alreadyPicked):
  penalty = 1.0

  // 같?? ??터????률 ??게 ??운
  if alreadyPicked.any(p => p.sector == candidate.sector):
    penalty *= 0.35

  // 리스??밴드 겹치??조금 ??운
  candBand = riskBand(candidate.riskScore)  // LOW(1-2) | MID(3) | HIGH(4-5)
  if alreadyPicked.any(p => riskBand(p.riskScore) == candBand):
    penalty *= 0.70

  return penalty
```

### Diversity Condition
??운??당 3????택지????음 조건??만족??야 ??

```java
isDiverseEnough(List<Asset> picked):
  // 최소 2????터
  distinctSectors = picked.map(p => p.sector).distinct().size
  if distinctSectors < 2: return false

  // 최소 2??리스??밴드
  distinctBands = picked.map(p => riskBand(p.riskScore)).distinct().size
  return distinctBands >= 2
```

**Retry Logic:**
- ??양??조건 ??패 ??최?? 5????시??
- ??시????`shownAssetIds` ??약 ??화

### Fallback Strategy
??보 부??????약 조건????계??으????화:

1. **First Try**: `shownAssetIds` ??외
2. **Fallback**: `shownAssetIds` ??약 ??화, `deckAssetIds`????외
3. **Last Resort**: ??양??조건 ??화 (경고 로그)

### Memory Efficiency
**Before (비효??:**
```java
List<Asset> allAssets = assetRepository.findByActiveTrue();  // ~1000??
// 메모?? ~100-200KB per round
```

**After (??율):**
```java
List<Asset> preferredCandidates = assetRepository.findBySectorInAndActiveTrue(preferredSectors);  // ~200-300??
List<Asset> wildCandidates = assetRepository.findBySectorNotInAndActiveTrue(preferredSectors);
// 메모?? 30-50% ??감
```

### Example Flow
```
Round 3:
  preferredSectors = [INFORMATION_TECHNOLOGY, HEALTH_CARE]
  riskProfile = BALANCED
  deckAssetIds = []
  shownAssetIds = []

1. Load preferredCandidates (IT + Healthcare assets, ~150??
2. Load wildCandidates (other sectors, ~650??
3. Pick 2 normal from preferredCandidates (??터 ??호 1.5?? 리스??가중치)
4. Pick 1 wild from wildCandidates (??터 무시, ??외??
5. Check diversity (2+ sectors, 2+ risk bands)
6. Return 3 assets

Result:
  [
    { assetId: "...", ticker: "AAPL", name: "Apple Inc.", sector: "INFORMATION_TECHNOLOGY" },
    { assetId: "...", ticker: "JNJ", name: "Johnson & Johnson", sector: "HEALTH_CARE" },
    { assetId: "...", ticker: "XOM", name: "Exxon Mobil", sector: "ENERGY" }  // wild pick
  ]
```

### Query Optimization (Bucket Sampling)

**Problem:**
??체 active assets (~1000????로드??는 것조????전??비효??적. ??히 `ORDER BY random()`?? ????량??서 ??능 ????

**Solution: Bucket Sampling**
DB??서 **??호 ??터 버킷 + 비선??버킷 + ????드 버킷**??로 각각 ??량 ??플??????에??가중치 계산

#### Bucket Sizes (Default)
- **Preferred Sector Candidates**: 80??
- **Non-Preferred Sector Candidates**: 40??
- **Wild Candidates**: 20??
- **Total**: ~140??(??체 1000??????86% ??감)

#### 1) Preferred Sector Bucket (80??
```sql
SELECT a.id, a.sector, a.current_risk_level, a.type, a.market
FROM assets a
WHERE a.active = true
  AND a.sector = ANY(:preferred_sectors)
  AND a.id <> ALL(:deck_asset_ids)
  AND a.id <> ALL(:shown_asset_ids)
  AND a.id >= :rand_id
ORDER BY a.id
LIMIT 80;
```

#### 2) Non-Preferred Sector Bucket (40??
```sql
SELECT a.id, a.sector, a.current_risk_level, a.type, a.market
FROM assets a
WHERE a.active = true
  AND (a.sector <> ALL(:preferred_sectors) OR :preferred_sectors_is_empty = true)
  AND a.id <> ALL(:deck_asset_ids)
  AND a.id <> ALL(:shown_asset_ids)
  AND a.id >= :rand_id
ORDER BY a.id
LIMIT 40;
```

#### 3) Wild Bucket (20??
```sql
SELECT a.id, a.sector, a.current_risk_level, a.type, a.market
FROM assets a
WHERE a.active = true
  AND a.id <> ALL(:deck_asset_ids)
  AND a.id <> ALL(:shown_asset_ids)
  AND a.id >= :rand_id
ORDER BY a.id
LIMIT 20;
```

#### Random Sampling Strategy (PK Range Random)

**ORDER BY random() 금??**: ????량 ??이블에????능 최악

### MVP 추천: PK 범위 ??덤
1. ??에??`minId ~ maxId` 캐시 (??는 ??드코딩)
2. `rand_id = random(minId, maxId)` ??성
3. `WHERE a.id >= :rand_id ORDER BY a.id LIMIT N`
4. 부족하??wrap-around: `WHERE a.id < :rand_id ORDER BY a.id LIMIT N`

**??점:**
- 빠름 (??덱????용)
- 구현 간단
- MVP??충분

**??점:**
- ID 분포가 매우 불균??이????향 가??(??부??괜찮??

**Advanced (??영 ??계):**
- `assets` ??이블에 `rand_key DOUBLE PRECISION` (0~1) 컬럼 추??
- 배치??주기??으????덤 ??갱신
- ??덱?? `(sector, rand_key)`
- 쿼리: `WHERE a.rand_key >= :rk ORDER BY a.rand_key LIMIT N`
- 진짜 빠르??깔끔??

#### Required Indexes
```sql
CREATE INDEX idx_asset_sector_active ON assets(sector, active);
CREATE INDEX idx_asset_active_id ON assets(active, id);
CREATE INDEX idx_asset_risk_level ON assets(current_risk_level);
```

#### Optimization Benefits
- **메모??*: 1000????140??(86% ??감)
- **쿼리 ??능**: ORDER BY random() ??거 ??PK range scan
- **??트??크**: ??이????송??86% 감소

#### Implementation Flow
```
1. DB??서 3??버킷 ??플??(??140??
   - Preferred: 80
   - Non-Preferred: 40
   - Wild: 20

2. App??서 가중치 계산 (140개에 ????
   - riskWeight × sectorWeight × diversityPenalty

3. Weighted sampling??로 최종 3????택
   - Normal picks: 2??(preferred ??선)
   - Wild pick: 1??(wild bucket ??선)

4. Diversity check (최?? 5????시??

5. Round????????반환
```

---

# 6) Portfolio Performance

## GET /portfolios/{portfolioId}/performance?range=1M|3M|1Y
Response
{
"portfolioId": "uuid",
"range": "1M",
"points": [
{ "date": "YYYY-MM-DD", "value": 100.0 }
]
}

---

# 7) Assets (종목)

## GET /assets/search?query=string
Response
[
{
"assetId": "uuid",
"ticker": "string",
"name": "string",
"exchange": "string|null",
"country": "string|null",
"sector": "string|null",
"imageUrl": "string|null"
}
]

## GET /assets/{assetId}
Response
{
"assetId": "uuid",
"ticker": "string",
"name": "string",
"exchange": "string|null",
"country": "string|null",
"sector": "string|null",
"currency": "string|null",
"imageUrl": "string|null",
"description": "string|null"
}

## GET /assets/{assetId}/chart?range=1M|3M|1Y
Response
{
"assetId": "uuid",
"range": "1M",
"points": [
{ "date": "YYYY-MM-DD", "price": 123.45 }
]
}

## GET /assets/{assetId}/in-my-main-portfolio
Response (not included)
{ "included": false }

Response (included)
{
"included": true,
"portfolioId": "uuid",
"weightPct": 25.0,
"returnPct": 18.3
}




